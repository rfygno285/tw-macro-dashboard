name: Daily Data Build

on:
  schedule:
    # GitHub 用 UTC；此為每日 00:05 UTC（台北 08:05）
    - cron: '5 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Print env & repo state
        run: |
          echo "Node:" && node -v
          echo "NPM:" && npm -v
          echo "PWD:" && pwd
          echo "List root:" && ls -la
          echo "package.json snapshot:" && (cat package.json || true)

      - name: Install dependencies
        run: npm ci --no-audit --no-fund || npm i

      - name: Ensure data folder
        run: mkdir -p docs/data

      - name: Run fetchers (non-blocking)
        run: |
          set -x
          npm run fetch:taibir || echo "::warning ::fetch:taibir failed"
          npm run fetch:cpi    || echo "::warning ::fetch:cpi failed"
          npm run fetch:unemp  || echo "::warning ::fetch:unemp failed"
          npm run fetch:m2     || echo "::warning ::fetch:m2 failed"

      - name: Ensure placeholders if missing
        run: |
          for f in taibir cpi unemployment m2; do
            [ -s "docs/data/$f.json" ] || echo "[]" > "docs/data/$f.json"
          done
          echo "Data folder listing:" && ls -la docs/data

      - name: Commit updated JSON
        run: |
          git config user.name "data-bot"
          git config user.email "data-bot@users.noreply.github.com"
          git add -A docs/data
          echo "---- git status ----"
          git status --porcelain
          git diff --cached --name-only || true
          git diff --cached --quiet && echo "No changes" || git commit -m "chore: data refresh"
          git push
